<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üß† BrainRot Trading & Chat</title>
<style>
body { font-family:'Poppins',sans-serif; background: radial-gradient(circle at top left,#000428,#004e92); color:white; margin:0; padding:20px; text-align:center;}
h1 { font-family:'Orbitron',sans-serif; font-size:3em; margin-top:20px; text-shadow:0 0 20px #00c6ff;}
.box { background: rgba(255,255,255,0.1); padding:20px; border-radius:20px; margin:20px auto; max-width:700px; text-align:center; box-shadow:0 0 40px rgba(0,198,255,0.3);}
input { padding:10px; border-radius:10px; border:none; width:70%; margin:5px 0;}
button { margin-top:10px; padding:10px 18px; border:none; border-radius:10px; background:linear-gradient(90deg,#00c6ff,#0072ff); color:white; font-weight:600; cursor:pointer;}
button:hover { transform:scale(1.05); }
#chatBox { max-height:300px; overflow-y:auto; margin-bottom:10px; text-align:left; background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;}
.message { padding:5px 10px; border-bottom:1px solid rgba(255,255,255,0.2);}
</style>
</head>
<body>
<h1>üß† BrainRot Trading & Chat</h1>

<!-- Trade-Anfrage -->
<div class="box">
<h2>1Ô∏è‚É£ Trade-Anfrage senden</h2>
<input type="text" id="robloxName" placeholder="Dein Roblox-Name"><br>
<input type="text" id="offer" placeholder="Dein Angebot"><br>
<button id="sendRequest">Anfrage senden</button>
<p id="tradeIdDisplay"></p>
<p id="requestStatus"></p>
</div>

<!-- Chat -->
<div class="box">
<h2>üí¨ Chat mit Admin</h2>
<input type="text" id="tradeIdInput" placeholder="Gib deine Trade-ID ein"><br>
<button id="loginChatBtn">Chat starten</button>
<div id="chatBox">Chat nur aktiv, wenn Admin die Anfrage angenommen hat.</div>
<input type="text" id="chatInput" placeholder="Nachricht eingeben">
<button id="sendChatBtn">Senden</button>
<p id="chatInfo"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
apiKey:"AIzaSyC1kLr0wdCM1HDWj8x7LvMV2Q0K6kzycUY",
authDomain:"brainrottradingseite.firebaseapp.com",
projectId:"brainrottradingseite",
storageBucket:"brainrottradingseite.firebasestorage.app",
messagingSenderId:"212738351089",
appId:"1:212738351089:web:9ae5b737cf550554d16e50",
measurementId:"G-BNZ0Y47M0K",
databaseURL:"https://brainrottradingseite-default-rtdb.europe-west1.firebasedatabase.app/"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// User-ID speichern
let userId = localStorage.getItem("userId");
if(!userId){ userId="user-"+Math.floor(Math.random()*100000); localStorage.setItem("userId",userId); }

const robloxNameInput = document.getElementById("robloxName");
const offerInput = document.getElementById("offer");
const sendRequestBtn = document.getElementById("sendRequest");
const tradeIdDisplay = document.getElementById("tradeIdDisplay");
const requestStatus = document.getElementById("requestStatus");

const tradeIdInput = document.getElementById("tradeIdInput");
const loginChatBtn = document.getElementById("loginChatBtn");
const chatBox = document.getElementById("chatBox");
const chatInput = document.getElementById("chatInput");
const sendChatBtn = document.getElementById("sendChatBtn");
const chatInfo = document.getElementById("chatInfo");

let activeChatRef = null;
let chatActive = false;
let lastSent = 0;
const cooldown = 5000;

// ----------------- Trade-Anfrage senden -----------------
sendRequestBtn.addEventListener("click", async()=>{
  const robloxName = robloxNameInput.value.trim();
  const offer = offerInput.value.trim();
  if(!robloxName || !offer){ alert("‚ö†Ô∏è Bitte alles ausf√ºllen!"); return; }

  const tradeRef = push(ref(db,"trades"));
  await set(tradeRef,{
    userId,
    robloxName,
    offer,
    accepted:false,
    time:Date.now()
  });

  tradeIdDisplay.textContent = "üÜî Deine Trade-ID: " + tradeRef.key;
  requestStatus.textContent = "‚úÖ Anfrage gesendet! Warte auf Admin-Freigabe.";
});

// ----------------- Chat-Login -----------------
loginChatBtn.addEventListener("click", ()=>{
  const enteredId = tradeIdInput.value.trim();
  if(!enteredId){ alert("‚ö†Ô∏è Bitte Trade-ID eingeben"); return; }
  const tradeRef = ref(db,"trades/"+enteredId);

  onValue(tradeRef, snapshot=>{
    const trade = snapshot.val();
    if(!trade){ alert("‚ö†Ô∏è Trade-ID ung√ºltig"); return; }
    if(trade.userId !== userId){ alert("‚ö†Ô∏è Diese Trade-ID geh√∂rt nicht dir"); return; }
    if(!trade.accepted){ chatBox.textContent = "‚è≥ Admin hat die Anfrage noch nicht angenommen."; chatActive=false; return; }

    // Chat freischalten
    activeChatRef = ref(db,"chats/"+enteredId);
    chatBox.textContent = "";
    chatActive = true;
    chatInfo.textContent = "üí¨ Chat aktiviert!";

    // Live-Chat anzeigen
    onValue(activeChatRef, snap=>{
      const messages = snap.val();
      chatBox.innerHTML="";
      if(!messages){ chatBox.textContent="üí¨ Noch keine Nachrichten"; return; }
      Object.values(messages).sort((a,b)=>a.time-b.time).forEach(msg=>{
        const div = document.createElement("div");
        div.className="message";
        div.textContent = `${msg.user}: ${msg.text}`;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }, {onlyOnce:false});
});

// ----------------- Nachricht senden -----------------
sendChatBtn.addEventListener("click", async()=>{
  if(!chatActive){ alert("‚ö†Ô∏è Chat noch nicht freigeschaltet!"); return; }
  const text = chatInput.value.trim();
  if(!text) return;
  const now = Date.now();
  if(now - lastSent < cooldown) return alert("‚ö†Ô∏è Warte ein paar Sekunden!");
  lastSent = now;
  const newRef = push(activeChatRef);
  await set(newRef,{user:"User", text, time:now});
  chatInput.value="";
});
</script>
</body>
</html>